# AVESDetect

AVESDetect is a deep learning framework designed to find the start and stop times of (possibly overlapping) sound events in a recording. We designed it with bioacoustics applications in mind, so it accepts annotations in the form of [Raven](https://ravensoundsoftware.com/software/raven-lite/) selection tables. 

![19_AL_Naranja_1025](https://github.com/earthspecies/sound_event_detection/assets/72874445/dcf9061b-870a-4697-a4e0-96cc35b56edf)

## Requirements

Requires `torch > 2.0` and the corresponding version of torchaudio. Other requirements can be installed with `pip intall -r requirements.txt`.

## Example usage:

Get the [Meerkat (MT) dataset](https://zenodo.org/record/6012310). Put the files from `MT` in `datasets/MT/raw`. Run the script `process_MT.py`.

Get pretrained weights for AVES, which is the backbone model. (https://storage.googleapis.com/esp-public-files/ported_aves/aves-base-bio.torchaudio.pt) Put them in `weights`. 

Process data into correct format:

`cd datasets/MT; python process_MT.py; cd .. ; cd ..`

Project setup:

`python main.py project-setup --train-info-fp=/home/jupyter/sound_event_detection/datasets/MT/formatted/train_info.csv --val-info-fp=/home/jupyter/sound_event_detection/datasets/MT/formatted/val_info.csv --test-info-fp=/home/jupyter/sound_event_detection/datasets/birdvox_full_night/formatted/test_info.csv --project-dir=/home/jupyter/sound_event_detection/projects/MT_experiment`

Train model:

`python main.py train-model --project-config-fp=/home/jupyter/sound_event_detection/projects/MT_experiment/project_config.yaml --name=demo --lr=.00005 --batch-size=4`

## Editing Project Config

After running `python main.py project-setup`, a `project_config.yaml` file will be created in the project directory you specified. This config file codifies how different labels will be handled by any model within this project. This config file is automatically generated by the project setup script, but you can edit this file to revise how these labels are handled. There are a few things you can edit:

1. `label_set`: This is a list of all the label types that a model will be able to output. It is automatically populated with all the label types that appear in the `Annotation` column of the selection table. If you want your model to ignore a particular label type, perhaps because there are few events with that label type, you must delete that label type from this list.

2. `label_mapping`: This is a set of `key: value` pairs. Often, it is useful to group multiple types of labels into one. For example, maybe in your data there are multiple species from the same family, and you would like the model to treat this entire family with one label type. Upon training, AVESDetect converts each annotation that appears as a `key` into the label specified by the corresponding `value`. When modifying `label_mapping`, you should ensure that each `value` that appears in `label_mapping` either also appears in `label_set`, or is the `unknown_label`.

3. `unknown_label`: This is set to `Unknown` by default. Any sound event labeled with the `unknown_label` will be treated as an event of interest, but the label type of the event will be treated as unknown. This may be desireable when there are vocalizations that are clearly audible, but are difficult for an annotator to identify to species. When the model is trained, it learns to predict a uniform distribution across possible label types whenever it encounters an event with the `unknown_label`. When the model is evaluated, it is not penalized for predicting the label of events which are annotated with the `unknown_label`. The `unknown_label` should not appear in the `label_set`.

For example, say you annotate your audio with the labels Red-eyed Vireo `REVI`, Philidelphia Vireo`PHVI`, and Unsure `REVI/PHVI`. To reflect your uncertainty about `REVI/PHVI`, your `label_set` would include `REVI` and `PHVI`, and your `label_mapping` would include the pairs `REVI: REVI`, `PHVI: PHVI`, and `REVI/PHVI: Unknown`. Alternatively, you could group both types of Vireo together by making your `label_set` only include `Vireo`, and your `label_mapping` include `REVI: Vireo`, `PHVI: Vireo`, `REVI/PHVI: Vireo`.
